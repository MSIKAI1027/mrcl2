<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ESP32 IO 控制系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    .status-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: gray;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h3 class="mb-4">ESP32 控制介面</h3>
    <ul class="nav nav-tabs" id="tabMenu">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#settings">設定</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#control">控制</a></li>
    </ul>

    <div class="tab-content mt-3">
      <!-- 設定頁面 -->
      <div class="tab-pane fade show active" id="settings">
        <table class="table table-bordered text-center">
          <thead class="table-light">
            <tr><th>#</th><th>GPIO</th><th>模式</th></tr>
          </thead>
          <tbody id="settingsTable"></tbody>
        </table>
        <button class="btn btn-primary" onclick="saveSettings()">儲存設定</button>
      </div>

      <!-- 控制頁面 -->
      <div class="tab-pane fade" id="control">
        <table class="table table-bordered text-center">
          <thead class="table-light">
            <tr><th>#</th><th>GPIO</th><th>名稱</th><th>控制</th><th>狀態</th></tr>
          </thead>
          <tbody id="controlTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const pinList = [2, 4, 5, 12, 13, 14, 15, 18, 19, 21];
    let pinModes = {};
    let pinStates = {};
    let pinNames = {};

    // 初始化 MQTT
    const client = mqtt.connect("wss://broker.mqttgo.io:8084/mqtt");

    client.on("connect", () => {
      console.log("MQTT Connected");
      client.subscribe("esp32/config");
      client.subscribe("esp32/status");
      client.publish("esp32/init", "request");  // 啟動請求
    });

    client.on("message", (topic, message) => {
      const data = JSON.parse(message.toString());

      if (topic === "esp32/config") {
        data.forEach(item => {
          pinModes[item.pin] = item.mode;
          pinNames[item.pin] = item.name || `IO${pinList.indexOf(item.pin) + 1}`;
        });
        renderSettings();
        renderControl();
      }

      if (topic === "esp32/status") {
        data.forEach(item => {
          pinStates[item.pin] = item.state;
        });
        updateControlUI();
      }
    });

    function renderSettings() {
      const table = document.getElementById("settingsTable");
      table.innerHTML = "";
      pinList.forEach((pin, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>GPIO${pin}</td>
          <td>
            <select class="form-select form-select-sm mode-select" data-pin="${pin}">
              <option value="INPUT" ${pinModes[pin] === 'INPUT' ? 'selected' : ''}>INPUT</option>
              <option value="OUTPUT" ${pinModes[pin] === 'OUTPUT' ? 'selected' : ''}>OUTPUT</option>
            </select>
          </td>
        `;
        table.appendChild(row);
      });
    }

    function renderControl() {
      const table = document.getElementById("controlTable");
      table.innerHTML = "";
      pinList.forEach((pin, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>GPIO${pin}</td>
          <td><input class="form-control form-control-sm name-input" data-pin="${pin}" value="${pinNames[pin] || ''}"></td>
          <td>
            <div class="form-check form-switch">
              <input class="form-check-input output-toggle" type="checkbox" data-pin="${pin}">
            </div>
          </td>
          <td><span class="status-indicator" id="led-${pin}"></span></td>
        `;
        table.appendChild(row);
      });
      updateControlUI();
    }

    function updateControlUI() {
      pinList.forEach(pin => {
        const mode = pinModes[pin];
        const state = pinStates[pin];

        const toggle = document.querySelector(`.output-toggle[data-pin='${pin}']`);
        const led = document.getElementById(`led-${pin}`);

        if (toggle) {
          if (mode === 'OUTPUT') {
            toggle.disabled = false;
            toggle.checked = state === 1;
          } else {
            toggle.disabled = true;
          }
        }

        if (led) {
          led.style.backgroundColor = (state === 1) ? 'gold' : 'gray';
        }
      });
    }

    // 切換輸出狀態
    document.addEventListener("change", (e) => {
      if (e.target.classList.contains("output-toggle")) {
        const pin = parseInt(e.target.dataset.pin);
        const state = e.target.checked ? 1 : 0;
        client.publish("esp32/control", JSON.stringify({ pin, state }));
      }

      if (e.target.classList.contains("name-input")) {
        const pin = parseInt(e.target.dataset.pin);
        pinNames[pin] = e.target.value;
      }
    });

    // 儲存設定
    function saveSettings() {
      const data = [];
      document.querySelectorAll(".mode-select").forEach(sel => {
        const pin = parseInt(sel.dataset.pin);
        const mode = sel.value;
        data.push({ pin, mode, name: pinNames[pin] || "" });
      });
      client.publish("esp32/config", JSON.stringify(data));
      alert("設定已送出至 ESP32");
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
